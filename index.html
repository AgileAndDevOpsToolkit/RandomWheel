<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roue des Prénoms</title>
  <link rel="stylesheet" href="styles/default.css">
</head>
<body>
  <div class="container">
    <h1>Roue des Prénoms</h1>
    <div class="input-section">
      <input type="text" id="namesInput" placeholder="Entrez les prénoms séparés par des point-virgules (ex: Jean;Marie;Pierre)">
      <div>
        <button id="createWheel" class="btn">Créer la roue</button>
        <button id="spinWheel" class="btn" disabled>Faire tourner la roue</button>
        <button id="resetWheel" class="btn" disabled>Réinitialiser</button>
        <button id="exportState" class="btn" disabled>Exporter l’état</button>
        <input type="file" id="importFile" style="display:none;">
        <button id="importState" class="btn">Importer un état</button>
      </div>
    </div>

    <div class="wheel-container">
      <div class="pointer"></div>
      <canvas id="wheelCanvas" width="400" height="400"></canvas>
    </div>

    <div class="result" id="result"></div>

    <div class="name-list">
      <h3>Liste des prénoms</h3>
      <div id="namesList"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const canvas = document.getElementById('wheelCanvas');
      const ctx = canvas.getContext('2d');
      const createWheelBtn = document.getElementById('createWheel');
      const spinWheelBtn = document.getElementById('spinWheel');
      const resetWheelBtn = document.getElementById('resetWheel');
      const exportStateBtn = document.getElementById('exportState');
      const importStateBtn = document.getElementById('importState');
      const importFileInput = document.getElementById('importFile');
      const namesInput = document.getElementById('namesInput');
      const resultElem = document.getElementById('result');
      const namesListElem = document.getElementById('namesList');

      let names = [];
      let selectedNames = [];
      let isSpinning = false;
      let initialized = false;
      let colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#33CC99', '#7AC142', '#00D8FF', '#FF6B6B', '#FFA07A', '#20B2AA', '#6A5ACD', '#32CD32', '#FFD700'];

      createWheelBtn.addEventListener('click', () => {
        updateNamesFromInput();
        if (names.length < 2) {
          alert('Veuillez entrer au moins deux prénoms.');
          return;
        }
        initialized = true;
        drawWheel();
        updateNamesList();
        spinWheelBtn.disabled = false;
        resetWheelBtn.disabled = false;
        createWheelBtn.disabled = true;
        exportStateBtn.disabled = false;
        resultElem.textContent = '';
      });

      namesInput.addEventListener('input', () => {
        if (!initialized) return;
        updateNamesFromInput();
        drawWheel();
        updateNamesList();
        spinWheelBtn.disabled = selectedNames.length >= names.length;
      });

      function updateNamesFromInput() {
        const inputNames = namesInput.value.split(';').map(n => n.trim()).filter(n => n);
        const newSelected = selectedNames.filter(n => inputNames.includes(n));
        names = inputNames;
        selectedNames = newSelected;
      }

      spinWheelBtn.addEventListener('click', () => {
        if (isSpinning || names.length === 0 || selectedNames.length === names.length) return;
        isSpinning = true;
        resultElem.textContent = '';
        spinWheelBtn.disabled = true;

        let randomIndex;
        do {
          randomIndex = Math.floor(Math.random() * names.length);
        } while (selectedNames.includes(names[randomIndex]));

        const selectedName = names[randomIndex];
        const segmentAngle = (2 * Math.PI) / names.length;
        const targetAngle = -(segmentAngle * randomIndex + segmentAngle / 2) - Math.PI / 2;
        const fullSpins = 20 + Math.floor(Math.random() * 11);
        const finalRotation = (fullSpins * 2 * Math.PI) + targetAngle;

        canvas.style.transition = 'transform 8s cubic-bezier(0.17, 0.67, 0.15, 1)';
        canvas.style.transform = `rotate(${finalRotation}rad)`;

        setTimeout(() => {
          isSpinning = false;
          selectedNames.push(selectedName);
          resultElem.textContent = `Le prénom choisi est : ${selectedName}`;
          updateNamesList();
          drawWheel();
          spinWheelBtn.disabled = selectedNames.length >= names.length;
          spinWheelBtn.textContent = spinWheelBtn.disabled ? "Tous les prénoms ont été tirés" : `Faire tourner la roue (${names.length - selectedNames.length} restant)`;
        }, 8000);
      });

      resetWheelBtn.addEventListener('click', () => {
        selectedNames = [];
        spinWheelBtn.disabled = false;
        spinWheelBtn.textContent = "Faire tourner la roue";
        createWheelBtn.disabled = false;
        exportStateBtn.disabled = false;
        initialized = false;
        canvas.style.transform = 'rotate(0rad)';
        drawWheel();
        updateNamesList();
        resultElem.textContent = '';
      });

      exportStateBtn.addEventListener('click', () => {
        const data = `${names.join(';')}\nPASSED:${selectedNames.join(';')}`;
        const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'etat_roue.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      importStateBtn.addEventListener('click', () => importFileInput.click());

      importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result.trim();
          const lines = content.split('\n');
          if (lines.length < 1) return;
          names = lines[0].split(';').map(name => name.trim()).filter(name => name.length > 0);
          selectedNames = lines[1]?.startsWith('PASSED:') ? lines[1].substring(7).split(';').map(n => n.trim()) : [];
          namesInput.value = names.join(';');
          initialized = true;
          drawWheel();
          updateNamesList();
          spinWheelBtn.disabled = selectedNames.length >= names.length;
          resetWheelBtn.disabled = false;
          createWheelBtn.disabled = true;
          exportStateBtn.disabled = false;
          resultElem.textContent = '';
        };
        reader.readAsText(file);
      });

      function drawWheel() {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 10;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const segmentAngle = (2 * Math.PI) / names.length;
        const angleOffset = Math.PI / 2;

        for (let i = 0; i < names.length; i++) {
          const startAngle = i * segmentAngle + angleOffset;
          const endAngle = (i + 1) * segmentAngle + angleOffset;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fillStyle = selectedNames.includes(names[i]) ? '#CCCCCC' : colors[i % colors.length];
          ctx.fill();
          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.rotate(startAngle + segmentAngle / 2);
          ctx.textAlign = 'right';
          ctx.fillStyle = '#000000';
          ctx.font = '14px Arial';
          const textMaxLength = radius * 0.8;
          let fontSize = 14;
          if (ctx.measureText(names[i]).width > textMaxLength) {
            fontSize = Math.floor(fontSize * (textMaxLength / ctx.measureText(names[i]).width));
            ctx.font = `${fontSize}px Arial`;
          }
          ctx.fillText(names[i], radius - 20, 5);
          ctx.restore();
        }

        ctx.beginPath();
        ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
        ctx.fillStyle = '#FFFFFF';
        ctx.fill();
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      function updateNamesList() {
        namesListElem.innerHTML = '';
        names.forEach(name => {
          const div = document.createElement('div');
          div.className = 'name-item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = selectedNames.includes(name);
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              if (!selectedNames.includes(name)) selectedNames.push(name);
            } else {
              selectedNames = selectedNames.filter(n => n !== name);
            }
            drawWheel();
            updateNamesList();
            spinWheelBtn.disabled = selectedNames.length >= names.length;
          });
          const label = document.createElement('label');
          label.textContent = name;
          if (checkbox.checked) label.classList.add('selected');
          div.appendChild(checkbox);
          div.appendChild(label);
          namesListElem.appendChild(div);
        });
      }
    });
  </script>
</body>
</html>
